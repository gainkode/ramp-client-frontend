<mat-card>
  <mat-card-header class="pd-15-f">
    <mat-card-title >Transaction Details</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <form [formGroup]="form"> 
      <mat-form-field appearance="outline" class="size-wider">
        <mat-label>Transaction type</mat-label>
        <mat-select formControlName="type">
          <mat-option *ngFor="let type of transactionTypes" [value]="type.id">
            {{ type.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="size-smaller">
        <mat-label>Source</mat-label>
        <mat-select formControlName="source">
          <mat-option *ngFor="let type of transactionSources" [value]="type.id">
            {{ type.name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field *ngIf="form.controls.source.value !== 'Wallet'" appearance="outline">
        <mat-label>Widget ID</mat-label>
        <mat-select formControlName="widgetUserParamsId">
          <mat-option *ngFor="let widget of widgetOptions$ | async" [value]="widget.id">
            {{ widget.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Customer search </mat-label>
        <input matInput
                formControlName="users"
                placeholder="Start typing to search users"
                [matAutocomplete]="auto">
                
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayUserTitleFn">
          <mat-option *ngFor="let user of usersOptions$ | async" [value]="user">
            {{ user.title }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      
      <div class="mt-2">
        <mat-form-field appearance="outline" class="size-wider">
          <mat-label>{{amountToSpendTitle}}</mat-label>
          <input matInput type="text" formControlName="amountToSpend" required/>
          <mat-error *ngIf="amountToSpendField.invalid" class="field-error">{{getAmountToSpendMessage()}}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="size-smaller">
          <mat-label>{{amountToSpendTitle}}</mat-label>
          <mat-select formControlName="currencyToSpend">
            <mat-option *ngFor="let c of currenciesToSpend" [value]="c.symbol">
              {{ c.display }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div *ngIf="transactionType !== 'Deposit' && transactionType !== 'Withdrawal'" class="mt-2">
        <mat-form-field appearance="outline" class="size-wider">
          <mat-label>Amount To Receive</mat-label>
          <input matInput type="text" formControlName="amountToReceive" required/>
          <mat-error *ngIf="amountToReceiveField.invalid" class="field-error">{{getAmountToRecievedMessage()}}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="size-smaller">
          <mat-select formControlName="currencyToReceive">
            <mat-option *ngFor="let c of currenciesToReceive" [value]="c.symbol">
              {{ c.display }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div>
        <mat-form-field appearance="outline" class="size-two-third">
          <mat-label>Exchange rate</mat-label>
          <input matInput type="text" formControlName="rate"/>
          <mat-error *ngIf="rateField.invalid" class="field-error">{{getRateMessage()}}</mat-error>
        </mat-form-field>

        <button 
          *ngIf="showSetCurrentRate" 
          class="fs-5"
          type="button" 
          mat-flat-button
          (click)="updateRate()">Set current
        </button>
      </div>

      <div class="mt-2">
        <mat-form-field appearance="outline" class="size-wider">
          <mat-label>Payment Methods</mat-label>
          <mat-select formControlName="instrument">
            <mat-option *ngFor="let type of instrumentTypes" [value]="type.id">
              {{ type.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="size-smaller">
          <mat-label>Payment providers</mat-label>
          <mat-select formControlName="paymentProvider">
            <mat-option *ngFor="let type of filteredProviders" [value]="type.id">
              {{ type.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </form>

    <ng-container *ngIf="transactionSimulation$ | async as data">
      <mat-card-header class="pd-15-f">
        <mat-card-title>Results</mat-card-title>
      </mat-card-header>
    
      <mat-form-field *ngIf="data?.costSchema?.name" appearance="outline">
        <mat-label>Used Cost Scheme</mat-label>
        <input matInput type="text" readonly [value]="data.costSchema.name"/>
      </mat-form-field>
  
      <mat-form-field *ngIf="data?.feeSchema?.name" appearance="outline">
        <mat-label>Used Fee Scheme</mat-label>
        <input matInput type="text" readonly [value]="data.feeSchema.name"/>
      </mat-form-field>

      <mat-form-field *ngIf="data?.bankAccount?.name" appearance="outline">
        <mat-label>Used Bank Account</mat-label>
        <input matInput type="text" readonly [value]="data.bankAccount.name"/>
      </mat-form-field>
  
      <mat-divider class="mb-2"></mat-divider>
    </ng-container>
  </mat-card-content>

  <mat-card-actions align="end">
    <button
      type="button"
      class="btn btn-primary me-sm-4 mb-sm-4"
      [disabled]="!form.valid" (click)="onSubmit()">
      Simulate
    </button>
  </mat-card-actions>

  <ng-container *ngIf="isProgress">
    <app-spinner [isTransparent]="true"></app-spinner>
  </ng-container>
</mat-card>