<div class="row">
  <div class="col-md-12 col-lg-12 col-xl-12 mx-auto d-block">
    <form novalidate [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="row">
        <div class="col-lg-4 col-md-12">
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Widget Data
            </h5>
            
            <app-admin-details-item label="Widget ID" [value]="widgetDetails?.id || ''">
            </app-admin-details-item>
            <app-admin-details-item label="Widget link" [value]="widgetDetails?.maskLink || ''">
            </app-admin-details-item>
            <app-admin-details-item label="Quick Checkout link" [linkUrl]="widgetDetails?.link || ''" [value]="widgetDetails?.link || ''">
            </app-admin-details-item>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Owner's Email
                <span class="main-content-label tx-11 tx-medium tx-danger">*</span>
              </label>
              <ng-select bindLabel="extendedName" notFoundText="No users found" formControlName="user"
                typeToSearchText="Type email or user name" placeholder="Start typing to search a user" required [items]="usersOptions$ | async"
                [minTermLength]="minUsersLengthTerm" [loading]="isUsersLoading"
                [multiple]="false" [typeahead]="usersSearchInput$">
              </ng-select>
              <div *ngIf="(form.controls.user.touched) && (form.controls.user.errors?.['required'])"
                class="tx-danger">
                <small>
                  Please specify a user
                </small>
              </div>
            </div>

            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Widget name
                <span class="main-content-label tx-11 tx-medium tx-danger">*</span>
              </label>
              <input class="form-control"
                type="text"
                formControlName="name" maxlength="50" required [ngClass]="{'has-error': (form.controls.name.touched) && !form.controls.name.valid}">
              <div *ngIf="(form.controls.name.touched) && (form.controls.name.errors?.['required'])"
                class="tx-danger">
                <small>
                  Widget name is required
                </small>
              </div>
            </div>

            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Description
              </label>
              <input class="form-control" type="text" formControlName="description" maxlength="150">
            </div>

            <div *ngIf="adminAdditionalSettings?.widgetDetails?.secret" class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Secret phrase
              </label>
              <input class="form-control" type="text" formControlName="secret" maxlength="100">
            </div>
          </div>
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Settings
            </h5>
           
            <!-- <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Min. Amount
              </label>
              <input class="form-control" type="number" formControlName="minAmountFrom">
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Max. Amount
              </label>
              <input class="form-control" type="number" formControlName="maxAmountFrom">
            </div>
     -->
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Pre. Fee
              </label>
              <input class="form-control" type="number" formControlName="fee">
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Merchant. Fee, %
              </label>
              <input class="form-control" type="number" formControlName="merchantFeePercent">
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      Allow to pay if kyc failed
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="allowToPayIfKycFailed">
                    </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      New Vault Per Transaction 
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="newVaultPerTransaction">
                    </div>
                </div>
              </div>
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      Kyc Before Payment
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="kycBeforePayment">
                    </div>
                </div>
              </div>
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      Disclaimer
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="disclaimer">
                    </div>
                </div>
              </div>
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      2FA
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="twoFA">
                    </div>
                </div>
              </div>
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      Show Rate
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="showRate">
                    </div>
                </div>
              </div>
            </div>
    
            <div class="form-group">
              <div class="__row-per-checkbox">
                <div class="__tool-bar-block">
                    <div class="__tool-bar-label">
                      Mask
                    </div>
                </div>
                <div class="__tool-bar-block mg-l-10-f">
                    <div class="__toggle-switch">
                        <input type="checkbox" id="toggle-button" class="__toggle-switch-slider"
                            formControlName="masked">
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-12">
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Destination
            </h5>
            <div class="form-group">
              <table mat-table [dataSource]="currenciesTable">
                <ng-container matColumnDef="details">
                  <th *matHeaderCellDef>
                    <i class="material-icons cursor-icon tx-20" (click)="addWidgetDestinationAddress()">
                      add_circle
                    </i>
                  </th>
                  <td *matCellDef="let element">
                    <i class="material-icons cursor-icon tx-20" (click)="delWidgetDestinationAddress(element)">
                      cancel
                    </i>
                  </td>
                </ng-container>
          
                  <ng-container matColumnDef="currency">
                    <th *matHeaderCellDef>
                      Currency
                    </th>
                    <td *matCellDef="let element" class="widget-list-data-column">
                      <ng-select 
                        bindLabel="display"
                        bindValue="symbol" 
                        [ngModelOptions]="{standalone: true}" 
                        [items]="currencyDestinationOptions" 
                        [clearable]="false" 
                        [clearOnBackspace]="true" 
                        [hideSelected]="true"
                        [closeOnSelect]="true" 
                        [(ngModel)]="element.currency"
                        (change)="element.destination = ''">
                      </ng-select>
                    </td>
                  </ng-container>
        
                  <ng-container matColumnDef="destination">
                    <th *matHeaderCellDef>
                      Destination
                    </th>
                    <td *matCellDef="let element; let i = index" class="widget-list-data-column">
                      <input 
                        appAddressValidator 
                        class="form-control"
                        type="text"
                        maxlength="50"
                        [id]="'input-' + i"
                        [elCurrency]="element.currency"
                        [elRequired]="element.destinationRequired" 
                        [ngClass]="{'has-error': element.destinationRequired && !element.destination}" 
                        [ngModelOptions]="{standalone: true}" 
                        [required]="element.destinationRequired" 
                        [(ngModel)]="element.destination">
                    </td>
                  </ng-container>
        
                  <tr *matHeaderRowDef="displayedColumns; sticky: true" mat-header-row></tr>
                  <tr *matRowDef="let row; columns: displayedColumns;" mat-row></tr>
                </table>
            </div>
          </div>
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Merchant fee destination
            </h5>
            <div class="form-group">
              <table mat-table [dataSource]="merchantFeeDestinationTable">
w                  <ng-container matColumnDef="details">
                    <th *matHeaderCellDef>
                      <i class="material-icons cursor-icon tx-20" (click)="addMerchantFeeDestinationAddress()">
                        add_circle
                      </i>
                    </th>
                    <td *matCellDef="let element">
                      <i class="material-icons cursor-icon tx-20" (click)="delMerchantFeeDestinationAddress(element)">
                        cancel
                      </i>
                    </td>
                  </ng-container>
          
                  <ng-container matColumnDef="currency">
                    <th *matHeaderCellDef>
                      Currency
                    </th>
                    <td *matCellDef="let element" class="widget-list-data-column">
                      <ng-select 
                        bindLabel="display"
                        bindValue="symbol" 
                        [ngModelOptions]="{standalone: true}" 
                        [items]="currencyMerchantDestinationOptions" 
                        [clearable]="false" 
                        [clearOnBackspace]="true" 
                        [hideSelected]="true"
                        [closeOnSelect]="true" 
                        [(ngModel)]="element.currency"
                        (change)="element.destination = ''">
                      </ng-select>
                    </td>
                  </ng-container>
        
                  <ng-container matColumnDef="destination">
                    <th *matHeaderCellDef>
                      Destination
                    </th>
                    <td *matCellDef="let element; let i = index" class="widget-list-data-column">
                      <input 
                        appAddressValidator 
                        class="was-validated form-control"
                        type="text"
                        maxlength="50"
                        [id]="'m-input-' + i"
                        [elCurrency]="element.currency"
                        [elRequired]="true" 
                        [ngClass]="{'has-error': !element.destination}" 
                        [ngModelOptions]="{standalone: true}"
                        [required]="true"
                        [(ngModel)]="element.destination">
                    </td>
                  </ng-container>
        
                  <tr *matHeaderRowDef="displayedColumns; sticky: true" mat-header-row></tr>
                  <tr *matRowDef="let row; columns: displayedColumns;" mat-row></tr>
                </table>
            </div>
          </div>
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Fiat Amount Setitngs
            </h5>
            <div class="form-group">
              <table #amountsTable mat-table [dataSource]="amountsSettingsTable">
                  <ng-container matColumnDef="details">
                    <th *matHeaderCellDef>
                      <i class="material-icons cursor-icon tx-20" (click)="addAmountSetting()">
                        add_circle
                      </i>
                    </th>
                    <td *matCellDef="let element; let i = index">
                      <i class="material-icons cursor-icon tx-20" (click)="deleteAmountSetting(i)">
                        cancel
                      </i>
                    </td>
                  </ng-container>
          
                  <ng-container matColumnDef="currency">
                    <th *matHeaderCellDef>
                      Currency
                    </th>
                    <td *matCellDef="let element" class="widget-list-data-column">
                      <ng-select 
                        bindLabel="display" 
                        bindValue="symbol" 
                        [ngModelOptions]="{standalone: true}" 
                        [items]="currencyOptionsFiat" 
                        [clearable]="false" 
                        [clearOnBackspace]="true"
                        [hideSelected]="true" 
                        [closeOnSelect]="true"
                        [(ngModel)]="element.currency">
                      </ng-select>
                    </td>
                  </ng-container>
        
                  <ng-container matColumnDef="minAmount">
                    <th *matHeaderCellDef>
                      Min. Amount
                    </th>
                    <td *matCellDef="let element; let i = index" class="widget-list-data-column">
                      <input 
                        class="was-validated form-control" 
                        type="text"
                        maxlength="10" 
                        [id]="'min-input-' + i" 
                        [ngModelOptions]="{standalone: true}"
                        [(ngModel)]="element.minAmount">
                    </td>
                  </ng-container>
      
                  <ng-container matColumnDef="maxAmount">
                    <th *matHeaderCellDef>
                      Max. Amount
                    </th>
                    <td *matCellDef="let element; let i = index" class="widget-list-data-column">
                      <input 
                        class="was-validated form-control" 
                        type="text"
                        maxlength="10" 
                        [id]="'max-input-' + i" 
                        [ngModelOptions]="{standalone: true}"
                        [(ngModel)]="element.maxAmount">
                    </td>
                  </ng-container>
        
                  <tr *matHeaderRowDef="displayedAmountsColumns; sticky: true" mat-header-row></tr>
                  <tr *matRowDef="let row; columns: displayedAmountsColumns;" mat-row></tr>
                </table>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-12">
          <div class="card card-body pd-20 pd-md-40 border shadow-none">
            <h5 class="card-title mg-b-20">
              Filtering Criteria
            </h5>
          
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Countries
              </label>
              <ng-select formControlName="countries" [clearable]=true [clearOnBackspace]=true [multiple]="true"
                [closeOnSelect]="false">
                <ng-option *ngFor="let country of countryOptions" [value]="country">
                  <app-dropdown-item imageClass="country-flag-admin" itemValue="{{country.name}}"
                    imageSource="assets/svg-country-flags/{{getCountryFlag(country.code2)}}">
                  </app-dropdown-item>
                </ng-option>
              </ng-select>
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Fiat Currencies
              </label>
              <ng-select bindLabel="display" bindValue="symbol" formControlName="currenciesFiat"
                [items]="currencyOptionsFiat" [clearable]=true [clearOnBackspace]=true [multiple]="true"
                [closeOnSelect]="false">
              </ng-select>
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Payment Methods
              </label>
              <ng-select bindLabel="name" bindValue="id" formControlName="instruments" [items]="instrumentOptions"
                [clearable]=true [clearOnBackspace]=true [multiple]="true" [closeOnSelect]="false">
              </ng-select>
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Liquidity provider
                <span class="main-content-label tx-11 tx-medium tx-danger">*</span>
              </label>
              <ng-select bindLabel="name" bindValue="id" formControlName="liquidityProvider"
                required [items]="liquidityProviderOptions" [clearable]=false [clearOnBackspace]=false>
              </ng-select>
              <div
                *ngIf="(form.controls.liquidityProvider.touched) && (form.controls.liquidityProvider.errors?.['required'])"
                class="tx-danger">
                <small>
                  Liquidity provider name is required
                </small>
              </div>
            </div>
    
            <div *ngIf="showPaymentProviders" class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Payment Providers
              </label>
              <ng-select bindLabel="name" bindValue="id" formControlName="paymentProviders" [items]="filteredProviders"
                [clearable]=true [clearOnBackspace]=true [multiple]="true" [closeOnSelect]="false">
              </ng-select>
            </div>
    
            <div class="form-group">
              <label class="main-content-label tx-11 tx-medium tx-gray-600">
                Transaction types
              </label>
              <ng-select bindLabel="name" bindValue="id" formControlName="transactionTypes" [items]="transactionTypeOptions"
                [clearable]=true [clearOnBackspace]=true [multiple]="true" [closeOnSelect]="false">
              </ng-select>
            </div>
    
            <label class="main-content-label tx-11 tx-medium tx-gray-600">
              User Type
              <span class="main-content-label tx-11 tx-medium tx-danger">*</span>
            </label>
            <ng-select bindLabel="name" bindValue="id" formControlName="userType" required
              [items]="userTypeOptions" [clearable]=false [clearOnBackspace]=false>
            </ng-select>
          </div>

          <div *ngIf="errorMessage!==''" class="card card-body card-danger pd-20 pd-md-40 border shadow-none">
            <h4 class="card-title2 mg-b-20 color_brown">
              {{errorMessage}}
            </h4>
          </div>
    
          <div class="d-flex justify-content-end">
            <ng-container *ngIf="permission > 1">
              <button type="submit"class="btn btn-primary pd-x-30 me-2 mg-t-5" [disabled]="!form.valid">
                <span *ngIf="saveInProgress" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Save
              </button>
              <button class="btn btn-danger pd-x-30 me-2 mg-t-5" type="button" (click)="onDeleteWidget(delete_confirm_content)">
                <span *ngIf="deleteInProgress" class="spinner-border spinner-border-sm" role="status"
                  aria-hidden="true"></span>
                Delete
              </button>
            </ng-container>
          
            <button class="btn btn-outline-primary pd-x-30 mg-t-5" type="button" (click)="close.emit()">
              Close
            </button>
          </div>
        </div>
      </div>
    </form>

    <ng-container *ngIf="isLoading">
			<app-spinner></app-spinner>
		</ng-container>
  </div>
</div>

<ng-template #delete_confirm_content let-modal>
  <div class="modal-header">
    <h5 class="modal-title">Delete widget</h5>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <h4 class="text-center">
      You are going to delete selected widget. Confirm operation.
    </h4>
    <div class="d-flex justify-content-center align-items-center">
      <button class="btn btn-outline-secondary pd-x-30 me-2 mg-t-5" type="button" (click)="modal.dismiss('Reject')">
        Reject
      </button>
      <button type="button" class="btn btn-danger pd-x-30 mg-t-5" (click)="modal.close('Confirm')">
        Confirm
      </button>
    </div>
  </div>
</ng-template>